# 微信授权消息通知

## 想要的效果

客户想要后台分配线索时对应的微信能够获取到消息通知，如下所示：

![iatV8b.png](https://i.328888.xyz/2023/05/06/iatV8b.png)

## 实现思路

配合后端查看微信开发文档，得知后端需要调用 [code2Session](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html) 方法获取用户的 `openid` 、`unionid` 、`session_key` 等信息，前端需要把最新的 `code` 传递过去。前端想要获取 `code` 则需要调用 `wx.login()` 方法获取。

使用 `wx.requestSubscribeMessage` 方法调起客户端小程序订阅消息界面，返回用户订阅消息的操作结果。

**参数**：

| 属性     | 类型     | 默认值 | 必填 | 说明                                                         |
| :------- | :------- | :----- | :--- | :----------------------------------------------------------- |
| tmplIds  | Array    |        | 是   | 需要订阅的消息模板的id的集合，一次调用最多可订阅3条消息（注意：iOS客户端7.0.6版本、Android客户端7.0.7版本之后的一次性订阅/长期订阅才支持多个模板消息，iOS客户端7.0.5版本、Android客户端7.0.6版本之前的一次订阅只支持一个模板消息）消息模板id在[微信公众平台(mp.weixin.qq.com)-功能-订阅消息]中配置。每个tmplId对应的模板标题需要不相同，否则会被过滤。 |
| success  | function |        | 否   | 接口调用成功的回调函数                                       |
| fail     | function |        | 否   | 接口调用失败的回调函数                                       |
| complete | function |        | 否   | 接口调用结束的回调函数（调用成功、失败都会执行               |

> 注意：
>
> 当用户勾选了订阅面板中的 “总是保持以上选择，不再询问” 时，模板消息会被添加到用户的小程序设置页，通过 [wx.getSetting](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/wx.getSetting.html) 接口可获取用户对相关模板消息的订阅状态