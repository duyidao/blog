# 前端文件上传与相关操作



## 前置知识

### 方案

- 通过二进制的 `blob` 传输，如通过 `formData` 传输
- 通过转为 `base64` 字符串上传，不过字符串体积会很大

### 相关对象

#### files

通过 `input` 标签读过来的文件对象。获取到的对象不能直接给后端，因为这个是前端的对象。

#### blob

不可变的二进制内容，包含很多操作方法。后端直接给前端前端也不认识，需要转换。

#### formData

用于和后端传输的对象。搭载 `files` 对象传递给后端。

#### fileReader

把文件读取为某种形式，如 `base64` 、`text` 文本等。

## files对象

下面有一个基础的上传文件结构：

```vue
<input type="file" @change="change" />

<script>
const change = e => {
    let file = e.target.files[0]
    console.log(file) // 包含文件类型、大小、名称等
    
    // 判断文件大小
    if(file.size > 1024 * 24 * 24) return
    
    // 判断文件类型
    if(file.type !== 'video/mp4') return
}
</script>
```

> 拓展：
>
> `file` 对象本质是 `File` 类的实例化。这是另外一种创建文件的方案，但一般不会这么做，因为不能让用户自己选择，也无法写入磁盘。
>
> ```js
> console.log(new File(['content'], 'a.txt'))
> ```
>
> 最终打印结果如下所示：
>
> ![iPLv6z.png](https://i.328888.xyz/2023/05/04/iPLv6z.png)

## blob对象

`file` 对象放进 `new Blob()` 方法内就能转换为 `blob` 对象。

`blob` 对象可以使用 `slice` 进行切割操作，放进 `new File()` 方法内就能转换为 `file` 对象。把切割后的 `blob` 放进去就能转为新的 `file` 对象。

```vue
<input type="file" @change="change" />

<script>
const change = e => {
    let file = e.target.files[0]
    const blob = new Blob([file])
    const sliceBlob = new Blob([file]).slice(0, 33)
    const sliceFile = new File([sliceBlob])
    console.log()
}
</script>
```

![iPMZQ5.png](https://i.328888.xyz/2023/05/04/iPMZQ5.png)

## fileReader对象

通过 `new FileReader` 定义一个方法，使用 `readAsDateURL` 读取文件信息。

> 注意：
>
> 该操作非同步操作，因此需要在他的 `onload` 事件中等待其解读完。
>
> ```js
> const fr = new FileReader()
> fr.readAsDateURL(file)
> fr.onload = function() {
>     console.log(fr.result)
> }
> ```
>
> 文件缩略图的实现原理就是通过截取 `base64` 通过 `readAsDateURL` 把内容显示在页面上（文本预览也是该操作）。

## formData对象

本质作用是把前端的 `file` 对象转为 `blob` 传递给后端。

```js
const change = e => {
    const formData = new FormData()
    formData.append('user', 'content')
    formData.append('file', e.target.file[0])
    axios.post('/xx', formData)
}
```

最终查看接口，传递的参数是二进制文件，请求头也是相应的 `form-data` 类型。

## 转换关系

![iPMjsV.png](https://i.328888.xyz/2023/05/04/iPMjsV.png)

## 上传方式

### 单多文件上传

多文件上传就是遍历文件数组，一个个声明 `formData` 对象，调接口传参。（即循环单文件上传）

### 切片上传

设置一个最大值，定义一个变量 `current` 初始值为0，上传文件时通过使用 `slice(current, current + 设置的允许最大上传的尺寸)` 上传文件，上传完后 `current` 加上当前上传的文件大小即可。

### 断点续传

当上传的时候中断了，例如4mb，把中断的值本地存储，下次上传时从第4mb开始传起。